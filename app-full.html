<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HCF DeFi Platform</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-label {
            color: #888;
            font-size: 0.9em;
            margin-bottom: 8px;
        }
        .stat-value {
            color: #333;
            font-size: 2em;
            font-weight: bold;
        }
        .stat-suffix {
            color: #667eea;
            font-size: 0.7em;
            margin-left: 5px;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }
        .card h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        .wallet-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .success {
            color: #4caf50;
            font-weight: bold;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }
        .close:hover {
            color: #333;
        }
        .input-group {
            margin: 20px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 16px;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .staking-levels {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .level-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .level-card:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        .level-card.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        .info-box {
            background: #f0f8ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
        }
        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ HCF DeFi Platform</h1>
            <p>BSCæµ‹è¯•ç½‘å»ä¸­å¿ƒåŒ–é‡‘èå¹³å° - è´¨æŠ¼æŒ–çŸ¿ã€èŠ‚ç‚¹NFTã€æ¨èç³»ç»Ÿ</p>
        </div>

        <div id="error-container"></div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">æ€»ä¾›åº”é‡</div>
                <div class="stat-value" id="totalSupply">1,000,000,000<span class="stat-suffix">HCF</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å½“å‰ä»·æ ¼</div>
                <div class="stat-value" id="currentPrice">$0.100<span class="stat-suffix">USDT</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æˆ‘çš„ä½™é¢</div>
                <div class="stat-value" id="myBalance">0<span class="stat-suffix">HCF</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">è´¨æŠ¼æ€»é‡</div>
                <div class="stat-value" id="totalStaked">0<span class="stat-suffix">HCF</span></div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ’³ é’±åŒ…è¿æ¥</h2>
            <div id="wallet-container">
                <p>è¿æ¥æ‚¨çš„MetaMaské’±åŒ…ä»¥å¼€å§‹ä½¿ç”¨å¹³å°åŠŸèƒ½</p>
                <button class="btn" onclick="connectWallet()">
                    è¿æ¥ MetaMask
                </button>
            </div>
        </div>

        <!-- è´¨æŠ¼æŒ–çŸ¿ -->
        <div class="card" id="staking-section" style="display:none;">
            <h2>ğŸ’° è´¨æŠ¼æŒ–çŸ¿</h2>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('stake')">è´¨æŠ¼</button>
                <button class="tab" onclick="switchTab('unstake')">å–æ¶ˆè´¨æŠ¼</button>
                <button class="tab" onclick="switchTab('claim')">é¢†å–å¥–åŠ±</button>
            </div>
            
            <div id="stake-tab" class="tab-content active">
                <div class="staking-levels">
                    <div class="level-card" onclick="selectLevel(1)">
                        <h3>Level 1</h3>
                        <p>æœ€ä½: 100 HCF</p>
                        <p>æ—¥åŒ–: 0.4%</p>
                    </div>
                    <div class="level-card" onclick="selectLevel(2)">
                        <h3>Level 2</h3>
                        <p>æœ€ä½: 1,000 HCF</p>
                        <p>æ—¥åŒ–: 0.5%</p>
                    </div>
                    <div class="level-card" onclick="selectLevel(3)">
                        <h3>Level 3</h3>
                        <p>æœ€ä½: 5,000 HCF</p>
                        <p>æ—¥åŒ–: 0.6%</p>
                    </div>
                    <div class="level-card" onclick="selectLevel(4)">
                        <h3>Level 4</h3>
                        <p>æœ€ä½: 10,000 HCF</p>
                        <p>æ—¥åŒ–: 0.7%</p>
                    </div>
                    <div class="level-card" onclick="selectLevel(5)">
                        <h3>Level 5</h3>
                        <p>æœ€ä½: 50,000 HCF</p>
                        <p>æ—¥åŒ–: 0.8%</p>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>è´¨æŠ¼æ•°é‡</label>
                    <input type="number" id="stakeAmount" placeholder="è¾“å…¥è´¨æŠ¼æ•°é‡">
                </div>
                
                <div class="info-box">
                    <p>é€‰æ‹©çš„ç­‰çº§: <span id="selectedLevel">æœªé€‰æ‹©</span></p>
                    <p>é¢„è®¡æ—¥æ”¶ç›Š: <span id="estimatedDaily">0</span> HCF</p>
                </div>
                
                <button class="btn" onclick="stake()">ç¡®è®¤è´¨æŠ¼</button>
            </div>
            
            <div id="unstake-tab" class="tab-content">
                <div class="info-box">
                    <p>å½“å‰è´¨æŠ¼: <span id="currentStaked">0</span> HCF</p>
                    <p>è´¨æŠ¼ç­‰çº§: <span id="stakingLevel">æ— </span></p>
                </div>
                <button class="btn" onclick="unstake()">å–æ¶ˆå…¨éƒ¨è´¨æŠ¼</button>
            </div>
            
            <div id="claim-tab" class="tab-content">
                <div class="info-box">
                    <p>å¯é¢†å–å¥–åŠ±: <span id="claimableRewards">0</span> HCF</p>
                </div>
                <button class="btn" onclick="claimRewards()">é¢†å–å¥–åŠ±</button>
            </div>
        </div>

        <!-- èŠ‚ç‚¹NFT -->
        <div class="card" id="nft-section" style="display:none;">
            <h2>ğŸ¨ èŠ‚ç‚¹NFT</h2>
            <div class="info-box">
                <p>èŠ‚ç‚¹ä»·æ ¼: 10,000 HCF</p>
                <p>å‰©ä½™æ•°é‡: <span id="remainingNodes">99</span> / 99</p>
                <p>æˆ‘çš„èŠ‚ç‚¹: <span id="myNodes">0</span> ä¸ª</p>
            </div>
            <button class="btn" onclick="buyNode()">è´­ä¹°èŠ‚ç‚¹NFT</button>
            <button class="btn btn-secondary" onclick="claimNodeRewards()">é¢†å–èŠ‚ç‚¹åˆ†çº¢</button>
        </div>

        <!-- æ¨èç³»ç»Ÿ -->
        <div class="card" id="referral-section" style="display:none;">
            <h2>ğŸ‘¥ æ¨èç³»ç»Ÿ</h2>
            <div class="info-box">
                <p>æˆ‘çš„æ¨èé“¾æ¥:</p>
                <input type="text" id="referralLink" readonly style="width:100%; padding:10px; margin:10px 0;">
                <button class="btn btn-secondary" onclick="copyReferralLink()">å¤åˆ¶é“¾æ¥</button>
            </div>
            <div class="info-box">
                <p>ç›´æ¨äººæ•°: <span id="directReferrals">0</span> äºº</p>
                <p>å›¢é˜Ÿäººæ•°: <span id="teamSize">0</span> äºº</p>
                <p>æ¨èå¥–åŠ±: <span id="referralRewards">0</span> HCF</p>
            </div>
            <button class="btn" onclick="claimReferralRewards()">é¢†å–æ¨èå¥–åŠ±</button>
        </div>

        <!-- åˆçº¦åœ°å€ -->
        <div class="card">
            <h2>ğŸ“‹ æ™ºèƒ½åˆçº¦</h2>
            <div style="font-family: monospace; font-size: 0.9em; line-height: 1.8;">
                <p>HCF Token: 0x09F320b75e6A74994713a0e4Be54eF8f09fbaEcc</p>
                <p>BSDT Token: 0x622e568976f6cC2eaE4cfd3836d92F111000E787</p>
                <p>Staking: 0x6E4e682Cc90124Ef66a8cfC8Fc875CF5Ee8E8a74</p>
                <p>NodeNFT: 0xFCd9c088f387C2C5a4ef87b87bde979a6EaAbA15</p>
                <p>Referral: 0x4DBDcfC87D528F616e5B11b9bc84e7C00F0Fc674</p>
            </div>
        </div>
    </div>

    <!-- åŠ è½½Ethers.js - ä½¿ç”¨å¯é çš„CDN -->
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    
    <!-- å¤‡ç”¨CDN -->
    <script>
        // æ£€æŸ¥ethersæ˜¯å¦åŠ è½½æˆåŠŸ
        window.addEventListener('load', function() {
            if (typeof ethers === 'undefined') {
                console.log('ä¸»CDNå¤±è´¥ï¼Œå°è¯•å¤‡ç”¨CDN...');
                var script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js';
                script.onload = function() {
                    console.log('Ethers.js åŠ è½½æˆåŠŸ (å¤‡ç”¨CDN)');
                };
                script.onerror = function() {
                    alert('æ— æ³•åŠ è½½ Ethers.js åº“ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                };
                document.head.appendChild(script);
            } else {
                console.log('Ethers.js åŠ è½½æˆåŠŸ');
            }
        });
    </script>
    
    <script>
        // åˆçº¦åœ°å€
        const CONTRACTS = {
            HCF: '0x09F320b75e6A74994713a0e4Be54eF8f09fbaEcc',
            BSDT: '0x622e568976f6cC2eaE4cfd3836d92F111000E787',
            Staking: '0x6E4e682Cc90124Ef66a8cfC8Fc875CF5Ee8E8a74',
            NodeNFT: '0xFCd9c088f387C2C5a4ef87b87bde979a6EaAbA15',
            Referral: '0x4DBDcfC87D528F616e5B11b9bc84e7C00F0Fc674'
        };

        // ç®€åŒ–çš„ABI
        const HCF_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function totalSupply() view returns (uint256)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function transfer(address to, uint256 amount) returns (bool)"
        ];

        const STAKING_ABI = [
            "function stake(uint256 amount, bool isLP, bool isEquity) returns (bool)",
            "function unstake() returns (bool)",
            "function claimReward() returns (bool)",
            "function getUserInfo(address user) view returns (tuple(uint256 amount, uint256 rewardDebt, uint256 pendingReward, uint256 lastStakeTime, uint256 level, bool isActive, uint256 totalClaimed, uint256 referralReward, bool isLP))"
        ];

        const NODE_NFT_ABI = [
            "function mintNode() returns (uint256)",
            "function balanceOf(address) view returns (uint256)",
            "function totalSupply() view returns (uint256)",
            "function NODE_PRICE() view returns (uint256)",
            "function claimDividends() returns (bool)"
        ];

        // å…¨å±€å˜é‡
        let provider = null;
        let signer = null;
        let account = null;
        let connected = false;
        let selectedStakeLevel = 0;

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            const walletContainer = document.getElementById('wallet-container');
            const errorContainer = document.getElementById('error-container');
            
            try {
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('è¯·å®‰è£… MetaMask é’±åŒ…æ‰©å±•');
                }

                walletContainer.innerHTML = '<button class="btn" disabled>è¿æ¥ä¸­<span class="loading"></span></button>';
                
                // åˆ›å»ºprovider
                provider = new ethers.providers.Web3Provider(window.ethereum);
                
                // è¯·æ±‚è´¦æˆ·
                const accounts = await provider.send("eth_requestAccounts", []);
                
                if (accounts.length === 0) {
                    throw new Error('æ²¡æœ‰æ‰¾åˆ°è´¦æˆ·');
                }
                
                account = accounts[0];
                signer = provider.getSigner();
                connected = true;
                
                // æ£€æŸ¥ç½‘ç»œ
                const network = await provider.getNetwork();
                if (network.chainId !== 97) { // BSC Testnet
                    await switchToBSCTestnet();
                }
                
                // æ›´æ–°UI
                walletContainer.innerHTML = `
                    <div class="wallet-info">
                        <p class="success">âœ… é’±åŒ…å·²è¿æ¥</p>
                        <p>åœ°å€: ${account.substring(0, 6)}...${account.substring(38)}</p>
                        <p>ç½‘ç»œ: BSC Testnet</p>
                        <button class="btn btn-secondary" onclick="disconnect()">æ–­å¼€è¿æ¥</button>
                    </div>
                `;
                
                // æ˜¾ç¤ºåŠŸèƒ½åŒºåŸŸ
                document.getElementById('staking-section').style.display = 'block';
                document.getElementById('nft-section').style.display = 'block';
                document.getElementById('referral-section').style.display = 'block';
                
                // åŠ è½½æ•°æ®
                await loadData();
                
                // ç”Ÿæˆæ¨èé“¾æ¥
                document.getElementById('referralLink').value = `https://hcf-finance.xyz?ref=${account}`;
                
                errorContainer.innerHTML = '';
                
            } catch (error) {
                console.error('è¿æ¥é”™è¯¯:', error);
                errorContainer.innerHTML = `<div class="error">é”™è¯¯: ${error.message}</div>`;
                walletContainer.innerHTML = '<button class="btn" onclick="connectWallet()">é‡æ–°è¿æ¥</button>';
            }
        }

        // åˆ‡æ¢åˆ°BSCæµ‹è¯•ç½‘
        async function switchToBSCTestnet() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x61' }],
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: '0x61',
                            chainName: 'BSC Testnet',
                            nativeCurrency: {
                                name: 'BNB',
                                symbol: 'BNB',
                                decimals: 18
                            },
                            rpcUrls: ['https://data-seed-prebsc-1-s1.binance.org:8545/'],
                            blockExplorerUrls: ['https://testnet.bscscan.com/']
                        }]
                    });
                }
            }
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            if (!connected) return;
            
            try {
                const hcfContract = new ethers.Contract(CONTRACTS.HCF, HCF_ABI, provider);
                const stakingContract = new ethers.Contract(CONTRACTS.Staking, STAKING_ABI, provider);
                const nodeContract = new ethers.Contract(CONTRACTS.NodeNFT, NODE_NFT_ABI, provider);
                
                // è·å–ä½™é¢
                const balance = await hcfContract.balanceOf(account);
                document.getElementById('myBalance').innerHTML = `${ethers.utils.formatUnits(balance, 18).slice(0, 10)}<span class="stat-suffix">HCF</span>`;
                
                // è·å–è´¨æŠ¼ä¿¡æ¯
                try {
                    const userInfo = await stakingContract.getUserInfo(account);
                    const stakedAmount = ethers.utils.formatUnits(userInfo.amount || userInfo[0], 18);
                    document.getElementById('currentStaked').textContent = stakedAmount;
                    document.getElementById('stakingLevel').textContent = `Level ${userInfo.level || userInfo[4]}`;
                    
                    const pendingReward = ethers.utils.formatUnits(userInfo.pendingReward || userInfo[2], 18);
                    document.getElementById('claimableRewards').textContent = pendingReward;
                } catch (e) {
                    console.log('è·å–è´¨æŠ¼ä¿¡æ¯å¤±è´¥:', e);
                }
                
                // è·å–èŠ‚ç‚¹ä¿¡æ¯
                try {
                    const nodeBalance = await nodeContract.balanceOf(account);
                    const totalNodes = await nodeContract.totalSupply();
                    document.getElementById('myNodes').textContent = nodeBalance.toString();
                    document.getElementById('remainingNodes').textContent = 99 - Number(totalNodes);
                } catch (e) {
                    console.log('è·å–èŠ‚ç‚¹ä¿¡æ¯å¤±è´¥:', e);
                }
                
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            }
        }

        // é€‰æ‹©è´¨æŠ¼ç­‰çº§
        function selectLevel(level) {
            selectedStakeLevel = level;
            document.querySelectorAll('.level-card').forEach(card => card.classList.remove('selected'));
            event.target.closest('.level-card').classList.add('selected');
            document.getElementById('selectedLevel').textContent = `Level ${level}`;
            
            const amount = document.getElementById('stakeAmount').value;
            if (amount) {
                const rates = [0.004, 0.005, 0.006, 0.007, 0.008];
                const daily = amount * rates[level - 1];
                document.getElementById('estimatedDaily').textContent = daily.toFixed(2);
            }
        }

        // è´¨æŠ¼
        async function stake() {
            if (!connected) {
                alert('è¯·å…ˆè¿æ¥é’±åŒ…');
                return;
            }
            
            const amount = document.getElementById('stakeAmount').value;
            if (!amount || amount <= 0) {
                alert('è¯·è¾“å…¥è´¨æŠ¼æ•°é‡');
                return;
            }
            
            try {
                const hcfContract = new ethers.Contract(CONTRACTS.HCF, HCF_ABI, signer);
                const stakingContract = new ethers.Contract(CONTRACTS.Staking, STAKING_ABI, signer);
                
                // æˆæƒ
                const amountWei = ethers.utils.parseUnits(amount, 18);
                const approveTx = await hcfContract.approve(CONTRACTS.Staking, amountWei);
                await approveTx.wait();
                
                // è´¨æŠ¼
                const stakeTx = await stakingContract.stake(amountWei, false, false);
                await stakeTx.wait();
                
                alert('è´¨æŠ¼æˆåŠŸï¼');
                await loadData();
                
            } catch (error) {
                console.error('è´¨æŠ¼å¤±è´¥:', error);
                alert('è´¨æŠ¼å¤±è´¥: ' + error.message);
            }
        }

        // å–æ¶ˆè´¨æŠ¼
        async function unstake() {
            if (!connected) {
                alert('è¯·å…ˆè¿æ¥é’±åŒ…');
                return;
            }
            
            try {
                const stakingContract = new ethers.Contract(CONTRACTS.Staking, STAKING_ABI, signer);
                const tx = await stakingContract.unstake();
                await tx.wait();
                
                alert('å–æ¶ˆè´¨æŠ¼æˆåŠŸï¼');
                await loadData();
                
            } catch (error) {
                console.error('å–æ¶ˆè´¨æŠ¼å¤±è´¥:', error);
                alert('å–æ¶ˆè´¨æŠ¼å¤±è´¥: ' + error.message);
            }
        }

        // é¢†å–å¥–åŠ±
        async function claimRewards() {
            if (!connected) {
                alert('è¯·å…ˆè¿æ¥é’±åŒ…');
                return;
            }
            
            try {
                const stakingContract = new ethers.Contract(CONTRACTS.Staking, STAKING_ABI, signer);
                const tx = await stakingContract.claimReward();
                await tx.wait();
                
                alert('é¢†å–æˆåŠŸï¼');
                await loadData();
                
            } catch (error) {
                console.error('é¢†å–å¤±è´¥:', error);
                alert('é¢†å–å¤±è´¥: ' + error.message);
            }
        }

        // è´­ä¹°èŠ‚ç‚¹
        async function buyNode() {
            if (!connected) {
                alert('è¯·å…ˆè¿æ¥é’±åŒ…');
                return;
            }
            
            try {
                const hcfContract = new ethers.Contract(CONTRACTS.HCF, HCF_ABI, signer);
                const nodeContract = new ethers.Contract(CONTRACTS.NodeNFT, NODE_NFT_ABI, signer);
                
                // è·å–ä»·æ ¼
                const price = await nodeContract.NODE_PRICE();
                
                // æˆæƒ
                const approveTx = await hcfContract.approve(CONTRACTS.NodeNFT, price);
                await approveTx.wait();
                
                // è´­ä¹°
                const mintTx = await nodeContract.mintNode();
                await mintTx.wait();
                
                alert('è´­ä¹°èŠ‚ç‚¹æˆåŠŸï¼');
                await loadData();
                
            } catch (error) {
                console.error('è´­ä¹°å¤±è´¥:', error);
                alert('è´­ä¹°å¤±è´¥: ' + error.message);
            }
        }

        // é¢†å–èŠ‚ç‚¹åˆ†çº¢
        async function claimNodeRewards() {
            if (!connected) {
                alert('è¯·å…ˆè¿æ¥é’±åŒ…');
                return;
            }
            
            try {
                const nodeContract = new ethers.Contract(CONTRACTS.NodeNFT, NODE_NFT_ABI, signer);
                const tx = await nodeContract.claimDividends();
                await tx.wait();
                
                alert('é¢†å–åˆ†çº¢æˆåŠŸï¼');
                await loadData();
                
            } catch (error) {
                console.error('é¢†å–å¤±è´¥:', error);
                alert('é¢†å–å¤±è´¥: ' + error.message);
            }
        }

        // å¤åˆ¶æ¨èé“¾æ¥
        function copyReferralLink() {
            const link = document.getElementById('referralLink');
            link.select();
            document.execCommand('copy');
            alert('é“¾æ¥å·²å¤åˆ¶ï¼');
        }

        // é¢†å–æ¨èå¥–åŠ±
        async function claimReferralRewards() {
            alert('æ¨èå¥–åŠ±åŠŸèƒ½å¼€å‘ä¸­...');
        }

        // åˆ‡æ¢æ ‡ç­¾
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.add('active');
        }

        // æ–­å¼€è¿æ¥
        function disconnect() {
            account = null;
            connected = false;
            provider = null;
            signer = null;
            
            document.getElementById('wallet-container').innerHTML = `
                <p>è¿æ¥æ‚¨çš„MetaMaské’±åŒ…ä»¥å¼€å§‹ä½¿ç”¨å¹³å°åŠŸèƒ½</p>
                <button class="btn" onclick="connectWallet()">è¿æ¥ MetaMask</button>
            `;
            
            document.getElementById('staking-section').style.display = 'none';
            document.getElementById('nft-section').style.display = 'none';
            document.getElementById('referral-section').style.display = 'none';
        }

        // ç›‘å¬è´¦æˆ·å˜åŒ–
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    disconnect();
                } else if (account !== accounts[0]) {
                    account = accounts[0];
                    connectWallet();
                }
            });
        }
    </script>
</body>
</html>